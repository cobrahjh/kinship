<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <title>Kinship</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #2563eb, #7c3aed); border-radius: 24px; margin-bottom: 24px; }
    .header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 16px; }

    /* Cards */
    .card { background: #1e293b; border-radius: 16px; padding: 24px; margin-bottom: 16px; }
    .card h2 { font-size: 20px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .card h2 span { font-size: 28px; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #1e293b; border-radius: 16px; padding: 20px; text-align: center; }
    .stat-number { font-size: 36px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 14px; color: #94a3b8; margin-top: 4px; }

    /* Voice Capture */
    .record-section { text-align: center; padding: 40px 20px; }
    .record-btn { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #334155; background: #1e293b; color: #f8fafc; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; }
    .record-btn:hover { border-color: #3b82f6; transform: scale(1.05); }
    .record-btn.recording { background: #ef4444; border-color: #dc2626; animation: pulse 1s infinite; }
    .record-btn .icon { font-size: 40px; margin-bottom: 8px; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .context-btns { display: flex; gap: 8px; justify-content: center; margin-top: 24px; flex-wrap: wrap; }
    .ctx-btn { padding: 10px 20px; border-radius: 24px; border: 1px solid #334155; background: #0f172a; color: #94a3b8; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .ctx-btn:hover { border-color: #3b82f6; }
    .ctx-btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }

    /* Entries List */
    .entries-list { max-height: 400px; overflow-y: auto; }
    .entry-item { background: #0f172a; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; }
    .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .entry-time { font-size: 12px; color: #64748b; }
    .entry-context { padding: 4px 10px; border-radius: 12px; font-size: 12px; background: #334155; }
    .entry-text { font-size: 15px; color: #cbd5e1; line-height: 1.5; }
    .entry-actions { margin-top: 12px; display: flex; gap: 8px; }
    .entry-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 12px; cursor: pointer; }
    .entry-btn.delete { background: #7f1d1d; color: #fecaca; }
    .entry-btn.transcribe { background: #1e3a5f; color: #93c5fd; }
    .entry-btn.analyze { background: #3b1e5f; color: #c4b5fd; }
    .entry-summary { font-size: 14px; color: #a5b4fc; margin-top: 8px; padding: 8px; background: #1e1e3f; border-radius: 8px; }
    .entry-meta { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .entry-tag { padding: 2px 8px; border-radius: 8px; font-size: 11px; background: #334155; color: #94a3b8; }
    .entry-tag.positive { background: #14532d; color: #86efac; }
    .entry-tag.negative { background: #7f1d1d; color: #fca5a5; }
    .entry-tag.neutral { background: #3f3f46; color: #a1a1aa; }
    .entry-tag.mixed { background: #78350f; color: #fcd34d; }

    /* Digest */
    .digest-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #a78bfa; }
    .digest-mood { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: #3b1e5f; color: #c4b5fd; margin-bottom: 16px; }
    .digest-narrative { font-size: 15px; line-height: 1.7; color: #cbd5e1; margin-bottom: 16px; white-space: pre-line; }
    .digest-section { margin-bottom: 16px; }
    .digest-section h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
    .digest-list { list-style: none; padding: 0; }
    .digest-list li { padding: 6px 0; color: #cbd5e1; font-size: 14px; }
    .digest-list li::before { content: "‚Ä¢"; color: #3b82f6; margin-right: 8px; }
    .digest-reflection { padding: 16px; background: linear-gradient(135deg, #1e3a5f, #3b1e5f); border-radius: 12px; font-style: italic; color: #e2e8f0; }
    .digest-stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .digest-stat { padding: 8px 16px; background: #1e293b; border-radius: 8px; font-size: 13px; color: #94a3b8; }

    /* Status Bar */
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #1e293b; border-radius: 12px; margin-bottom: 24px; font-size: 14px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; display: inline-block; margin-right: 8px; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #94a3b8; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .tab-btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }

    .empty-state { text-align: center; padding: 40px; color: #64748b; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Kinship</h1>
      <p>Your AI Memory Companion</p>
    </div>

    <div class="status-bar">
      <div><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div>
      <div><span class="status-dot" id="claudeDot" style="background:#64748b"></span><span id="claudeText">Claude</span></div>
      <div id="datetime"></div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">Total Notes</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayCount">0</div>
        <div class="stat-label">Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="streakCount">1</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('capture')">Capture</button>
      <button class="tab-btn" onclick="showTab('journal')">Journal</button>
      <button class="tab-btn" onclick="showTab('digest')">Digest</button>
    </div>

    <div id="captureTab">
      <div class="card">
        <h2><span>üéôÔ∏è</span> Voice Capture</h2>
        <p style="color: #94a3b8; margin-bottom: 20px;">Tap and hold to record. Release to save.</p>
        <div class="record-section">
          <button class="record-btn" id="recordBtn">
            <span class="icon">üé§</span>
            <span>TAP TO RECORD</span>
          </button>
          <div class="context-btns">
            <button class="ctx-btn active" data-ctx="auto">Auto</button>
            <button class="ctx-btn" data-ctx="health">üè• Health</button>
            <button class="ctx-btn" data-ctx="idea">üí° Idea</button>
            <button class="ctx-btn" data-ctx="personal">üè† Personal</button>
            <button class="ctx-btn" data-ctx="work">üíº Work</button>
          </div>
          <p id="recordStatus" style="margin-top: 20px; color: #64748b;">Ready to capture your thoughts</p>
        </div>
      </div>
    </div>

    <div id="journalTab" style="display: none;">
      <div class="card">
        <h2><span>üìù</span> Your Notes</h2>
        <div class="entries-list" id="entriesList">
          <div class="empty-state">
            <div class="icon">üéôÔ∏è</div>
            <p>No notes yet.<br>Record your first voice note!</p>
          </div>
        </div>
      </div>
    </div>

    <div id="digestTab" style="display: none;">
      <div class="card">
        <h2><span>üìä</span> Daily Digest</h2>
        <div style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center;">
          <input type="date" id="digestDate" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 14px;">
          <button onclick="loadDigest()" style="padding: 8px 16px; border-radius: 8px; border: none; background: #2563eb; color: #fff; cursor: pointer;">Generate</button>
        </div>
        <div id="digestContent">
          <div class="empty-state">
            <div class="icon">üìä</div>
            <p>Select a date and click Generate<br>to create your daily digest.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let recording = false;
    let mediaRecorder = null;
    let chunks = [];
    let context = 'auto';

    // Update datetime
    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // Context buttons
    document.querySelectorAll('.ctx-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.ctx-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        context = btn.dataset.ctx;
      };
    });

    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById('captureTab').style.display = tab === 'capture' ? 'block' : 'none';
      document.getElementById('journalTab').style.display = tab === 'journal' ? 'block' : 'none';
      document.getElementById('digestTab').style.display = tab === 'digest' ? 'block' : 'none';
      if (tab === 'journal') loadEntries();
      if (tab === 'digest') {
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('digestDate').value = today;
      }
    }

    // Record button
    document.getElementById('recordBtn').onclick = async () => {
      const btn = document.getElementById('recordBtn');
      const status = document.getElementById('recordStatus');

      if (!recording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          chunks = [];

          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = uploadRecording;
          mediaRecorder.start();

          recording = true;
          btn.classList.add('recording');
          btn.innerHTML = '<span class="icon">‚èπÔ∏è</span><span>RECORDING...</span>';
          status.textContent = 'Listening...';
        } catch (err) {
          status.textContent = 'Microphone access denied';
          console.error(err);
        }
      } else {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        recording = false;
        btn.classList.remove('recording');
        btn.innerHTML = '<span class="icon">üé§</span><span>TAP TO RECORD</span>';
        status.textContent = 'Processing...';
      }
    };

    async function uploadRecording() {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const form = new FormData();
      form.append('audio', blob, 'recording.webm');
      form.append('timestamp', new Date().toISOString());
      form.append('device', 'web');
      form.append('context', context);

      try {
        const res = await fetch('/api/lifelog/ingest', { method: 'POST', body: form });
        const data = await res.json();
        document.getElementById('recordStatus').textContent = data.success ? '‚úì Saved!' : '‚úó Failed';
        loadStats();
      } catch (e) {
        document.getElementById('recordStatus').textContent = '‚úó Network error';
      }

      setTimeout(() => {
        document.getElementById('recordStatus').textContent = 'Ready to capture your thoughts';
      }, 2000);
    }

    // Load stats
    async function loadStats() {
      try {
        const status = await fetch('/api/status').then(r => r.json());
        document.getElementById('totalCount').textContent = status.total || 0;
        document.getElementById('todayCount').textContent = status.today || 0;

        // Update status bar with Whisper info
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        if (status.whisperEnabled) {
          statusDot.style.background = '#22c55e';
          statusText.textContent = 'Whisper';
        } else {
          statusDot.style.background = '#f59e0b';
          statusText.textContent = 'Whisper Off';
        }

        // Update Claude status
        const claudeDot = document.getElementById('claudeDot');
        const claudeText = document.getElementById('claudeText');
        if (status.claudeEnabled) {
          claudeDot.style.background = '#a78bfa';
          claudeText.textContent = 'Claude';
        } else {
          claudeDot.style.background = '#64748b';
          claudeText.textContent = 'Claude Off';
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // Load entries
    async function loadEntries() {
      try {
        const entries = await fetch('/api/lifelog/entries').then(r => r.json());
        const list = document.getElementById('entriesList');

        if (entries.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="icon">üéôÔ∏è</div>
              <p>No notes yet.<br>Record your first voice note!</p>
            </div>
          `;
          return;
        }

        list.innerHTML = entries.slice().reverse().map(e => `
          <div class="entry-item" data-id="${e.id}">
            <div class="entry-header">
              <span class="entry-context">${getContextEmoji(e.context)} ${e.context}</span>
              <span class="entry-time">${formatTime(e.timestamp)}</span>
            </div>
            <div class="entry-text">${e.transcript || '<em style="color:#64748b">Audio note (transcription pending)</em>'}</div>
            ${e.summary ? `<div class="entry-summary">üí° ${e.summary}</div>` : ''}
            ${e.sentiment || e.topics ? `
              <div class="entry-meta">
                ${e.sentiment ? `<span class="entry-tag ${e.sentiment}">${e.mood || e.sentiment}</span>` : ''}
                ${e.topics ? e.topics.map(t => `<span class="entry-tag">${t}</span>`).join('') : ''}
              </div>
            ` : ''}
            <div class="entry-actions">
              ${!e.transcript && e.audioPath ? `<button class="entry-btn transcribe" onclick="transcribeEntry(${e.id})">Transcribe</button>` : ''}
              ${e.transcript && !e.summary ? `<button class="entry-btn analyze" onclick="analyzeEntry(${e.id})">Analyze</button>` : ''}
              <button class="entry-btn delete" onclick="deleteEntry(${e.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function getContextEmoji(ctx) {
      const emojis = { auto: 'üìù', health: 'üè•', idea: 'üí°', personal: 'üè†', work: 'üíº' };
      return emojis[ctx] || 'üìù';
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    async function deleteEntry(id) {
      if (!confirm('Delete this note?')) return;
      try {
        await fetch(`/api/lifelog/entries/${id}`, { method: 'DELETE' });
        loadEntries();
        loadStats();
      } catch (e) {
        alert('Failed to delete');
      }
    }

    async function transcribeEntry(id) {
      const btn = document.querySelector(`[data-id="${id}"] .transcribe`);
      if (btn) {
        btn.textContent = 'Transcribing...';
        btn.disabled = true;
      }
      try {
        const res = await fetch(`/api/lifelog/transcribe/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadEntries();
        } else {
          alert('Transcription failed: ' + (data.error || 'Unknown error'));
          if (btn) {
            btn.textContent = 'Transcribe';
            btn.disabled = false;
          }
        }
      } catch (e) {
        alert('Transcription failed');
        if (btn) {
          btn.textContent = 'Transcribe';
          btn.disabled = false;
        }
      }
    }

    async function analyzeEntry(id) {
      const btn = document.querySelector(`[data-id="${id}"] .analyze`);
      if (btn) {
        btn.textContent = 'Analyzing...';
        btn.disabled = true;
      }
      try {
        const res = await fetch(`/api/lifelog/analyze/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadEntries();
        } else {
          alert('Analysis failed: ' + (data.error || 'Unknown error'));
          if (btn) {
            btn.textContent = 'Analyze';
            btn.disabled = false;
          }
        }
      } catch (e) {
        alert('Analysis failed');
        if (btn) {
          btn.textContent = 'Analyze';
          btn.disabled = false;
        }
      }
    }

    async function loadDigest() {
      const dateStr = document.getElementById('digestDate').value;
      if (!dateStr) {
        alert('Please select a date');
        return;
      }

      const content = document.getElementById('digestContent');
      content.innerHTML = '<div class="empty-state"><div class="icon">‚è≥</div><p>Generating your daily digest...</p></div>';

      try {
        const res = await fetch(`/api/lifelog/digest/${dateStr}?ai=true`);
        const data = await res.json();

        if (data.totalEntries === 0) {
          content.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No entries for this date.</p></div>';
          return;
        }

        let html = `<div class="digest-stats">
          <div class="digest-stat">üìù ${data.totalEntries} entries</div>
          <div class="digest-stat">üí¨ ${data.topics?.length || 0} topics</div>
          <div class="digest-stat">‚úÖ ${data.actionItems?.length || 0} actions</div>
        </div>`;

        if (data.ai) {
          html += `
            <div class="digest-title">${data.ai.title}</div>
            <span class="digest-mood">${data.ai.overallMood}</span>
            <div class="digest-narrative">${data.ai.narrative}</div>
          `;

          if (data.ai.highlights?.length) {
            html += `<div class="digest-section">
              <h3>‚ú® Highlights</h3>
              <ul class="digest-list">${data.ai.highlights.map(h => `<li>${h}</li>`).join('')}</ul>
            </div>`;
          }

          if (data.ai.actionItems?.length) {
            html += `<div class="digest-section">
              <h3>üìã Action Items</h3>
              <ul class="digest-list">${data.ai.actionItems.map(a => `<li>${a}</li>`).join('')}</ul>
            </div>`;
          }

          if (data.ai.reflection) {
            html += `<div class="digest-reflection">üí≠ ${data.ai.reflection}</div>`;
          }
        } else if (data.aiError) {
          html += `<p style="color: #f59e0b;">AI digest unavailable: ${data.aiError}</p>`;
          // Show basic stats
          if (data.topics?.length) {
            html += `<div class="digest-section"><h3>Topics</h3><div class="entry-meta">${data.topics.map(t => `<span class="entry-tag">${t}</span>`).join('')}</div></div>`;
          }
        } else {
          html += '<p style="color: #94a3b8;">Set ANTHROPIC_API_KEY to enable AI-powered digests.</p>';
        }

        content.innerHTML = html;
      } catch (e) {
        console.error(e);
        content.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><p>Failed to load digest.</p></div>';
      }
    }

    // Initial load
    loadStats();
  </script>
</body>
</html>
