<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="Your AI Memory Companion - capture voice notes, track moods, and gain insights">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Kinship">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Kinship</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.svg">
  <link rel="icon" type="image/svg+xml" href="/icon.svg">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #2563eb, #7c3aed); border-radius: 24px; margin-bottom: 24px; }
    .header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 16px; }

    /* Cards */
    .card { background: #1e293b; border-radius: 16px; padding: 24px; margin-bottom: 16px; }
    .card h2 { font-size: 20px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .card h2 span { font-size: 28px; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #1e293b; border-radius: 16px; padding: 20px; text-align: center; }
    .stat-number { font-size: 36px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 14px; color: #94a3b8; margin-top: 4px; }

    /* Voice Capture */
    .record-section { text-align: center; padding: 40px 20px; }
    .record-btn { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #334155; background: #1e293b; color: #f8fafc; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; }
    .record-btn:hover { border-color: #3b82f6; transform: scale(1.05); }
    .record-btn.recording { background: #ef4444; border-color: #dc2626; animation: pulse 1s infinite; }
    .record-btn .icon { font-size: 40px; margin-bottom: 8px; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .context-btns { display: flex; gap: 8px; justify-content: center; margin-top: 24px; flex-wrap: wrap; }
    .ctx-btn { padding: 10px 20px; border-radius: 24px; border: 1px solid #334155; background: #0f172a; color: #94a3b8; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .ctx-btn:hover { border-color: #3b82f6; }
    .ctx-btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }

    /* Family Improvements */
    .sync-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 13px; transition: all 0.3s; }
    .sync-indicator.idle { background: #334155; color: #94a3b8; }
    .sync-indicator.syncing { background: #1e3a5f; color: #60a5fa; }
    .sync-indicator.success { background: #14532d; color: #86efac; }
    .sync-indicator.error { background: #7f1d1d; color: #fca5a5; }
    .sync-indicator .spinner { width: 14px; height: 14px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .member-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: #fff; flex-shrink: 0; }

    .unread-badge { position: absolute; top: -4px; right: -4px; min-width: 18px; height: 18px; background: #ef4444; border-radius: 9px; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; padding: 0 5px; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 14px 20px; border-radius: 12px; background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 12px; max-width: 350px; }
    .toast.success { border-color: #22c55e; }
    .toast.info { border-color: #3b82f6; }
    .toast.warning { border-color: #f59e0b; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .confirm-modal { background: rgba(0,0,0,0.8); }
    .confirm-modal .modal-content { text-align: center; }
    .confirm-buttons { display: flex; gap: 12px; margin-top: 20px; }
    .confirm-buttons button { flex: 1; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
    .confirm-buttons .cancel { background: #334155; color: #f8fafc; }
    .confirm-buttons .danger { background: #dc2626; color: #fff; }

    .qr-container { text-align: center; padding: 20px; background: #fff; border-radius: 12px; margin: 16px 0; }

    /* Entries List */
    .entries-list { max-height: 400px; overflow-y: auto; }
    .entry-item { background: #0f172a; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; }
    .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .entry-time { font-size: 12px; color: #64748b; }
    .entry-context { padding: 4px 10px; border-radius: 12px; font-size: 12px; background: #334155; }
    .entry-text { font-size: 15px; color: #cbd5e1; line-height: 1.5; }
    .entry-actions { margin-top: 12px; display: flex; gap: 8px; }
    .entry-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 12px; cursor: pointer; }
    .entry-btn.delete { background: #7f1d1d; color: #fecaca; }
    .entry-btn.transcribe { background: #1e3a5f; color: #93c5fd; }
    .entry-btn.analyze { background: #3b1e5f; color: #c4b5fd; }
    .entry-summary { font-size: 14px; color: #a5b4fc; margin-top: 8px; padding: 8px; background: #1e1e3f; border-radius: 8px; }
    .entry-meta { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .entry-tag { padding: 2px 8px; border-radius: 8px; font-size: 11px; background: #334155; color: #94a3b8; }
    .entry-tag.positive { background: #14532d; color: #86efac; }
    .entry-tag.negative { background: #7f1d1d; color: #fca5a5; }
    .entry-tag.neutral { background: #3f3f46; color: #a1a1aa; }
    .entry-tag.mixed { background: #78350f; color: #fcd34d; }

    /* Digest */
    .digest-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #a78bfa; }
    .digest-mood { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: #3b1e5f; color: #c4b5fd; margin-bottom: 16px; }
    .digest-narrative { font-size: 15px; line-height: 1.7; color: #cbd5e1; margin-bottom: 16px; white-space: pre-line; }
    .digest-section { margin-bottom: 16px; }
    .digest-section h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
    .digest-list { list-style: none; padding: 0; }
    .digest-list li { padding: 6px 0; color: #cbd5e1; font-size: 14px; }
    .digest-list li::before { content: "‚Ä¢"; color: #3b82f6; margin-right: 8px; }
    .digest-reflection { padding: 16px; background: linear-gradient(135deg, #1e3a5f, #3b1e5f); border-radius: 12px; font-style: italic; color: #e2e8f0; }
    .digest-stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .digest-stat { padding: 8px 16px; background: #1e293b; border-radius: 8px; font-size: 13px; color: #94a3b8; }

    /* Status Bar */
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #1e293b; border-radius: 12px; margin-bottom: 24px; font-size: 14px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; display: inline-block; margin-right: 8px; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #94a3b8; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .tab-btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }

    .empty-state { text-align: center; padding: 40px; color: #64748b; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

    /* Plugin iframe styles */
    .plugin-frame {
      width: 100%;
      min-height: 80vh;
      border: none;
      border-radius: 16px;
      background: #fff;
      display: block;
    }

    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    /* ============ BEHAVIORAL FEATURES ============ */

    /* Progress Visualization */
    .progress-card { background: #1e293b; border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .progress-header h3 { font-size: 16px; font-weight: 600; }
    .streak-badge { display: flex; align-items: center; gap: 4px; padding: 4px 12px; background: #7c3aed; border-radius: 12px; font-size: 13px; }
    .week-days { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .day-indicator { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .day-indicator .day-name { font-size: 11px; color: #64748b; text-transform: uppercase; }
    .day-indicator .day-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.2s; }
    .day-dot.empty { background: #334155; border: 2px dashed #475569; }
    .day-dot.filled { background: #22c55e; color: #fff; }
    .day-dot.today { box-shadow: 0 0 0 2px #2563eb; }
    .day-dot.future { background: #1e293b; border: 2px solid #334155; opacity: 0.5; }
    .progress-bar-container { background: #334155; border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 8px; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #7c3aed); transition: width 0.3s ease; }
    .progress-message { font-size: 13px; color: #94a3b8; text-align: center; }

    /* One-Tap Mood */
    .mood-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid #334155; }
    .mood-label { color: #94a3b8; font-size: 14px; margin-bottom: 12px; text-align: center; }
    .mood-buttons { display: flex; justify-content: center; gap: 12px; }
    .mood-btn { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #334155; background: #1e293b; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .mood-btn:hover { border-color: #2563eb; transform: scale(1.1); }
    .mood-btn.selected { transform: scale(1.1); }
    .mood-btn[data-score="0.1"]:hover, .mood-btn[data-score="0.1"].selected { background: #7f1d1d; border-color: #dc2626; }
    .mood-btn[data-score="0.3"]:hover, .mood-btn[data-score="0.3"].selected { background: #78350f; border-color: #f59e0b; }
    .mood-btn[data-score="0.5"]:hover, .mood-btn[data-score="0.5"].selected { background: #3f3f46; border-color: #a1a1aa; }
    .mood-btn[data-score="0.7"]:hover, .mood-btn[data-score="0.7"].selected { background: #14532d; border-color: #22c55e; }
    .mood-btn[data-score="0.9"]:hover, .mood-btn[data-score="0.9"].selected { background: #166534; border-color: #4ade80; }
    .mood-emoji { font-size: 28px; }
    .mood-note-section { margin-top: 16px; }
    .mood-note-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 14px; min-height: 60px; resize: none; font-family: inherit; }
    .mood-note-input:focus { outline: none; border-color: #2563eb; }
    .mood-actions { display: flex; gap: 8px; margin-top: 12px; }
    .mood-actions button { flex: 1; padding: 10px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .mood-cancel { border: 1px solid #334155; background: transparent; color: #94a3b8; }
    .mood-save { border: none; background: #2563eb; color: #fff; }
    .mood-status { margin-top: 12px; color: #64748b; font-size: 13px; text-align: center; }

    /* Fresh Start Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-content { background: #1e293b; border-radius: 20px; padding: 24px; max-width: 350px; width: 100%; text-align: center; animation: modalIn 0.3s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal-emoji { font-size: 48px; margin-bottom: 12px; }
    .modal-title { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
    .modal-message { color: #94a3b8; margin-bottom: 20px; font-size: 15px; }
    .intention-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 15px; min-height: 80px; resize: none; font-family: inherit; margin-bottom: 16px; }
    .intention-input:focus { outline: none; border-color: #2563eb; }
    .modal-actions { display: flex; gap: 8px; }
    .modal-actions button { flex: 1; padding: 12px; border-radius: 12px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .modal-dismiss { border: 1px solid #334155; background: transparent; color: #94a3b8; }
    .modal-confirm { border: none; background: #2563eb; color: #fff; }

    /* Settings Button */
    #settingsBtn:hover { background: rgba(255,255,255,0.3); transform: rotate(45deg); }

    /* ============ MOBILE PWA OPTIMIZATIONS ============ */

    /* Safe area handling for notched devices */
    body {
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .container {
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    /* Touch feedback */
    button, .tab-btn, .ctx-btn, .mood-btn, .entry-actions button {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    button:active, .tab-btn:active, .ctx-btn:active {
      transform: scale(0.96);
      opacity: 0.9;
    }

    /* Minimum touch targets (44px) */
    .tab-btn { min-height: 44px; }
    .ctx-btn { min-height: 44px; min-width: 44px; }
    .entry-actions button { min-width: 44px; min-height: 44px; padding: 10px 14px; }
    #settingsBtn { min-width: 44px; min-height: 44px; }

    /* Responsive breakpoints */
    @media (max-width: 360px) {
      .container { padding: 12px; }
      .header { padding: 24px 16px; border-radius: 16px; }
      .header h1 { font-size: 26px; }
      .card { padding: 16px; }
      .record-btn { width: 120px; height: 120px; }
      .mood-buttons { gap: 8px; }
      .mood-btn { width: 48px; height: 48px; }
      .mood-emoji { font-size: 22px; }
      .week-days { gap: 4px; }
      .day-dot { width: 28px; height: 28px; font-size: 12px; }
    }

    @media (min-width: 600px) and (max-width: 900px) {
      .container { max-width: 700px; }
      .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (min-width: 900px) {
      .container { max-width: 800px; }
      .stats-grid { grid-template-columns: repeat(3, 1fr); }
      .header { border-radius: 28px; }
    }

    /* Landscape orientation */
    @media (orientation: landscape) and (max-height: 500px) {
      .header { padding: 20px; margin-bottom: 16px; }
      .record-section { padding: 20px; }
      .record-btn { width: 100px; height: 100px; }
      .record-btn .icon { font-size: 32px; }
    }

    /* Standalone PWA mode adjustments */
    @media (display-mode: standalone) {
      .header { padding-top: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" style="position: relative;">
      <button id="settingsBtn" onclick="openSettings()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; transition: all 0.2s;" title="Settings">‚öôÔ∏è</button>
      <h1>Kinship</h1>
      <p>Your AI Memory Companion</p>
    </div>

    <div class="status-bar">
      <div><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div>
      <div><span class="status-dot" id="claudeDot" style="background:#64748b"></span><span id="claudeText">Claude</span></div>
      <div id="datetime"></div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">Total Notes</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayCount">0</div>
        <div class="stat-label">Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="streakCount">1</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" onclick="showTab('capture')">Capture</button>
      <button class="tab-btn" onclick="showTab('journal')">Journal</button>
      <button class="tab-btn" onclick="showTab('search')">Search</button>
      <button class="tab-btn" onclick="showTab('digest')">Digest</button>
      <button class="tab-btn" onclick="showTab('patterns')">Patterns</button>
      <button class="tab-btn" id="familyTabBtn" onclick="showTab('family')" style="display: none; position: relative;">Family<span class="unread-badge" id="familyUnreadBadge" style="display: none;">0</span></button>
    </div>

    <div id="captureTab">
      <!-- Progress Visualization -->
      <div class="progress-card" id="progressCard">
        <div class="progress-header">
          <h3>This Week</h3>
          <div class="streak-badge">
            <span>üî•</span>
            <span id="progressStreak">0</span>
            <span>day streak</span>
          </div>
        </div>
        <div class="week-days" id="weekDays">
          <!-- Populated by JS -->
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="weekProgressBar" style="width: 0%;"></div>
        </div>
        <p class="progress-message" id="progressMessage">Loading...</p>
      </div>

      <div class="card">
        <h2><span>üéôÔ∏è</span> Voice Capture</h2>
        <p style="color: #94a3b8; margin-bottom: 20px;">Tap and hold to record. Release to save.</p>
        <div class="record-section">
          <button class="record-btn" id="recordBtn">
            <span class="icon">üé§</span>
            <span>TAP TO RECORD</span>
          </button>
          <div class="context-btns">
            <button class="ctx-btn active" data-ctx="auto">Auto</button>
            <button class="ctx-btn" data-ctx="health">üè• Health</button>
            <button class="ctx-btn" data-ctx="idea">üí° Idea</button>
            <button class="ctx-btn" data-ctx="personal">üè† Personal</button>
            <button class="ctx-btn" data-ctx="work">üíº Work</button>
          </div>
          <p id="recordStatus" style="margin-top: 20px; color: #64748b;">Ready to capture your thoughts</p>
        </div>

        <!-- One-Tap Mood -->
        <div class="mood-section">
          <p class="mood-label">Or quickly log how you're feeling</p>
          <div class="mood-buttons" id="moodButtons">
            <button class="mood-btn" data-mood="üòî" data-score="0.1" onclick="selectMood(this)">
              <span class="mood-emoji">üòî</span>
            </button>
            <button class="mood-btn" data-mood="üòï" data-score="0.3" onclick="selectMood(this)">
              <span class="mood-emoji">üòï</span>
            </button>
            <button class="mood-btn" data-mood="üòê" data-score="0.5" onclick="selectMood(this)">
              <span class="mood-emoji">üòê</span>
            </button>
            <button class="mood-btn" data-mood="üôÇ" data-score="0.7" onclick="selectMood(this)">
              <span class="mood-emoji">üôÇ</span>
            </button>
            <button class="mood-btn" data-mood="üòä" data-score="0.9" onclick="selectMood(this)">
              <span class="mood-emoji">üòä</span>
            </button>
          </div>
          <div class="mood-note-section" id="moodNoteSection" style="display: none;">
            <textarea class="mood-note-input" id="moodNote" placeholder="Add a quick note (optional)..."></textarea>
            <div class="mood-actions">
              <button class="mood-cancel" onclick="cancelMood()">Cancel</button>
              <button class="mood-save" onclick="saveMood()">Save Mood</button>
            </div>
          </div>
          <p class="mood-status" id="moodStatus"></p>
        </div>
      </div>
    </div>

    <div id="journalTab" style="display: none;">
      <div class="card">
        <h2><span>üìù</span> Your Notes</h2>
        <div class="entries-list" id="entriesList">
          <div class="empty-state">
            <div class="icon">üéôÔ∏è</div>
            <p>No notes yet.<br>Record your first voice note!</p>
          </div>
        </div>
      </div>
    </div>

    <div id="searchTab" style="display: none;">
      <div class="card">
        <h2><span>üîç</span> Semantic Search</h2>
        <p style="color: #94a3b8; margin-bottom: 16px;">Search by meaning, not just keywords. Find related thoughts across all your notes.</p>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" id="searchQuery" placeholder="What are you looking for?" style="flex: 1; padding: 12px 16px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 15px;">
          <button onclick="semanticSearch()" style="padding: 12px 24px; border-radius: 12px; border: none; background: #2563eb; color: #fff; cursor: pointer; font-size: 15px;">Search</button>
        </div>
        <div id="searchResults">
          <div class="empty-state">
            <div class="icon">üîç</div>
            <p>Enter a question or topic to search<br>across all your voice notes.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="digestTab" style="display: none;">
      <div class="card">
        <h2><span>üìä</span> <span id="digestTitle">Daily Digest</span></h2>
        <div style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
          <div style="display: flex; gap: 4px;">
            <button id="digestDayBtn" onclick="setDigestMode('day')" class="ctx-btn active">Day</button>
            <button id="digestWeekBtn" onclick="setDigestMode('week')" class="ctx-btn">Week</button>
          </div>
          <input type="date" id="digestDate" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 14px;">
          <button onclick="loadDigest()" style="padding: 8px 16px; border-radius: 8px; border: none; background: #2563eb; color: #fff; cursor: pointer;">Generate</button>
        </div>
        <div id="digestContent">
          <div class="empty-state">
            <div class="icon">üìä</div>
            <p>Select a date and click Generate<br>to create your digest.</p>
          </div>
        </div>
      </div>
    </div>
  
    <div id="patternsTab" style="display: none;">
      <div class="card">
        <h2><span>üìà</span> Pattern Detection</h2>
        <div style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
          <select id="patternDays" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc;">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="60">Last 60 days</option>
            <option value="90">Last 90 days</option>
          </select>
          <label style="display: flex; align-items: center; gap: 6px; color: #94a3b8;">
            <input type="checkbox" id="patternAI" checked> AI Insights
          </label>
          <button onclick="loadPatterns()" style="padding: 8px 16px; border-radius: 8px; border: none; background: #2563eb; color: #fff; cursor: pointer;">Analyze</button>
        </div>
        <div id="patternsContent">
          <div class="empty-state">
            <div class="icon">üìà</div>
            <p>Click Analyze to detect patterns<br>in your voice notes.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Family Tab -->
    <div id="familyTab" style="display: none;">
      <div class="section-card" id="familySetupCard" style="display: none;">
        <h3 style="margin-bottom: 16px;">Family Sharing</h3>
        <p style="color: #94a3b8; margin-bottom: 16px;">Share voice notes with your family and get combined insights.</p>

        <div id="noFamilySetup">
          <button class="action-btn" onclick="showCreateFamilyModal()" style="width: 100%; margin-bottom: 12px; background: linear-gradient(135deg, #2563eb, #7c3aed);">Create Family</button>
          <button class="action-btn" onclick="showJoinFamilyModal()" style="width: 100%; background: #334155;">Join Family</button>
        </div>
      </div>

      <div class="section-card" id="familyInfoCard" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 id="familyDisplayName">Family Name</h3>
          <button onclick="showFamilySettings()" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px;">‚öôÔ∏è</button>
        </div>

        <div id="familyMembersList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;"></div>

        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <button class="action-btn" id="syncFamilyBtn" onclick="syncFamily()" style="flex: 1; background: #2563eb;">
            <span id="syncBtnText">Sync Now</span>
          </button>
          <button class="action-btn" onclick="showInviteModal()" style="flex: 1; background: #334155;">Invite</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
          <p style="font-size: 12px; color: #64748b;" id="lastSyncText">Last sync: Never</p>
          <div class="sync-indicator idle" id="syncIndicator">
            <span id="syncStatusIcon">‚óè</span>
            <span id="syncStatusText">Ready</span>
          </div>
        </div>
      </div>

      <div class="section-card" id="familyDigestCard" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3>Family Digest</h3>
          <input type="date" id="familyDigestDate" onchange="loadFamilyDigest()" style="padding: 8px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc;">
        </div>
        <div id="familyDigestContent">
          <p style="color: #64748b; text-align: center; padding: 20px;">Select a date to view family digest</p>
        </div>
      </div>

      <div class="section-card">
        <h3 style="margin-bottom: 16px;">Family Feed</h3>
        <div id="familyFeed">
          <p style="color: #64748b; text-align: center; padding: 20px;">No shared entries yet</p>
        </div>
      </div>
    </div>

    <!-- Plugin Tabs Container -->
    <div id="pluginTabsContainer"></div>
  </div>

  <!-- Profile Setup Modal -->
  <div class="modal-overlay" id="profileModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <h2 style="font-size: 20px; margin-bottom: 8px;">Welcome to Kinship</h2>
      <p style="color: #94a3b8; margin-bottom: 20px;">Let's set up your profile</p>

      <div style="margin-bottom: 16px;">
        <label style="font-size: 14px; color: #94a3b8; display: block; margin-bottom: 8px;">Your Name</label>
        <input type="text" id="profileNameInput" placeholder="Enter your name" maxlength="50" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 16px;">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #94a3b8; display: block; margin-bottom: 8px;">Pick Your Color</label>
        <div id="profileColorPicker" style="display: flex; gap: 10px; flex-wrap: wrap;">
          <div class="color-dot selected" data-color="#3b82f6" style="width: 36px; height: 36px; border-radius: 50%; background: #3b82f6; cursor: pointer; border: 3px solid transparent;"></div>
          <div class="color-dot" data-color="#22c55e" style="width: 36px; height: 36px; border-radius: 50%; background: #22c55e; cursor: pointer; border: 3px solid transparent;"></div>
          <div class="color-dot" data-color="#f59e0b" style="width: 36px; height: 36px; border-radius: 50%; background: #f59e0b; cursor: pointer; border: 3px solid transparent;"></div>
          <div class="color-dot" data-color="#ef4444" style="width: 36px; height: 36px; border-radius: 50%; background: #ef4444; cursor: pointer; border: 3px solid transparent;"></div>
          <div class="color-dot" data-color="#8b5cf6" style="width: 36px; height: 36px; border-radius: 50%; background: #8b5cf6; cursor: pointer; border: 3px solid transparent;"></div>
          <div class="color-dot" data-color="#ec4899" style="width: 36px; height: 36px; border-radius: 50%; background: #ec4899; cursor: pointer; border: 3px solid transparent;"></div>
        </div>
      </div>

      <button onclick="saveProfile()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #2563eb, #7c3aed); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;">Continue</button>
    </div>
  </div>

  <!-- Create Family Modal -->
  <div class="modal-overlay" id="createFamilyModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Create Family</h2>
        <button onclick="closeCreateFamilyModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #94a3b8; display: block; margin-bottom: 8px;">Family Name</label>
        <input type="text" id="createFamilyNameInput" placeholder="e.g., The Smiths" maxlength="100" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 16px;">
      </div>

      <button onclick="createFamily()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #2563eb, #7c3aed); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;">Create Family</button>
    </div>
  </div>

  <!-- Join Family Modal -->
  <div class="modal-overlay" id="joinFamilyModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Join Family</h2>
        <button onclick="closeJoinFamilyModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #94a3b8; display: block; margin-bottom: 8px;">Invite Code</label>
        <input type="text" id="joinFamilyCodeInput" placeholder="Paste invite code here" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 14px;">
      </div>

      <button onclick="joinFamily()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #2563eb, #7c3aed); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;">Join Family</button>
    </div>
  </div>

  <!-- Invite Modal -->
  <div class="modal-overlay" id="inviteModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Invite to Family</h2>
        <button onclick="closeInviteModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <p style="color: #94a3b8; margin-bottom: 16px;">Share this code with family members:</p>

      <div class="qr-container" id="qrCodeContainer">
        <canvas id="qrCodeCanvas"></canvas>
        <p style="color: #64748b; font-size: 12px; margin-top: 8px;">Scan with phone camera</p>
      </div>

      <div style="background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <input type="text" id="inviteCodeDisplay" readonly style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #f8fafc; font-size: 13px; margin-bottom: 8px;">
        <button onclick="copyInviteCode()" id="copyInviteBtn" style="width: 100%; padding: 10px; background: #2563eb; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 14px;">Copy Invite Code</button>
      </div>

      <p style="font-size: 12px; color: #64748b; text-align: center;">Or send via email:</p>
      <a id="inviteEmailLink" href="#" style="display: block; text-align: center; color: #3b82f6; margin-top: 8px; text-decoration: none;">Send Email Invite</a>
    </div>
  </div>

  <!-- Family Settings Modal -->
  <div class="modal-overlay" id="familySettingsModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Family Settings</h2>
        <button onclick="closeFamilySettings()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Sync Folder</h3>
        <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Set the folder path for syncing with family (e.g., Dropbox, Google Drive)</p>
        <input type="text" id="syncPathInput" placeholder="C:\Users\Shared\KinshipFamily" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 13px;">
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Family Members</h3>
        <div id="familySettingsMembersList" style="max-height: 150px; overflow-y: auto;"></div>
      </div>

      <button onclick="showLeaveFamilyConfirm()" style="width: 100%; padding: 12px; background: #7f1d1d; border: none; border-radius: 8px; color: #fca5a5; font-size: 14px; cursor: pointer;">Leave Family</button>
    </div>
  </div>

  <!-- Leave Family Confirmation Modal -->
  <div class="modal-overlay confirm-modal" id="leaveFamilyModal" style="display: none;">
    <div class="modal-content" style="max-width: 360px;">
      <div style="font-size: 48px; margin-bottom: 16px;">üëã</div>
      <h2 style="font-size: 20px; margin-bottom: 8px;">Leave Family?</h2>
      <p style="color: #94a3b8; margin-bottom: 8px;">Are you sure you want to leave <strong id="leaveFamilyName"></strong>?</p>
      <p style="color: #64748b; font-size: 13px;">Your shared entries will no longer be visible to family members.</p>
      <div class="confirm-buttons">
        <button class="cancel" onclick="closeLeaveFamilyModal()">Cancel</button>
        <button class="danger" onclick="confirmLeaveFamily()">Leave Family</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">‚öôÔ∏è Settings</h2>
        <button onclick="closeSettings()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">API Keys</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="background: #0f172a; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>OpenAI (Whisper + Embeddings)</span>
              <span id="settingsWhisper" style="color: #64748b;">Checking...</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <input type="password" id="openaiKeyInput" placeholder="sk-..." style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #f8fafc; font-size: 13px;">
              <button onclick="saveOpenAIKey()" style="padding: 8px 16px; background: #2563eb; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">Save</button>
            </div>
          </div>
          <div style="background: #0f172a; border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Anthropic (Claude Analysis)</span>
              <span id="settingsClaude" style="color: #64748b;">Checking...</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <input type="password" id="anthropicKeyInput" placeholder="sk-ant-..." style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #f8fafc; font-size: 13px;">
              <button onclick="saveAnthropicKey()" style="padding: 8px 16px; background: #7c3aed; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">Save</button>
            </div>
          </div>
          <p style="font-size: 11px; color: #64748b;">Keys are stored in memory only. Set environment variables for persistence.</p>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Data</h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; justify-content: space-between; padding: 12px; background: #0f172a; border-radius: 8px;">
            <span>Total Entries</span>
            <span id="settingsTotal" style="color: #3b82f6;">0</span>
          </div>
          <button onclick="embedAll()" style="padding: 12px; background: #1e3a5f; border: none; border-radius: 8px; color: #93c5fd; cursor: pointer; font-size: 14px;">Generate Embeddings for All Entries</button>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Fresh Start Prompts</h3>
        <button onclick="resetFreshStart()" style="padding: 12px; width: 100%; background: #334155; border: none; border-radius: 8px; color: #f8fafc; cursor: pointer; font-size: 14px;">Reset Fresh Start (show again)</button>
      </div>

      <div style="border-top: 1px solid #334155; padding-top: 16px; text-align: center; color: #64748b; font-size: 12px;">
        Kinship v1.5.0 ‚Ä¢ Your data stays local
      </div>
    </div>
  </div>

  <!-- Fresh Start Modal -->
  <div class="modal-overlay" id="freshStartModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-emoji" id="freshStartEmoji">üåÖ</div>
      <h2 class="modal-title" id="freshStartTitle">Fresh Week!</h2>
      <p class="modal-message" id="freshStartMessage">A new week begins. Would you like to set an intention?</p>
      <textarea class="intention-input" id="intentionInput" placeholder="My intention is..."></textarea>
      <div class="modal-actions">
        <button class="modal-dismiss" onclick="dismissFreshStart()">Not Now</button>
        <button class="modal-confirm" onclick="saveIntention()">Set Intention</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" id="shareModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Share Entry</h2>
        <button onclick="closeShareModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>

      <div id="shareContent">
        <div style="background: #0f172a; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <p id="shareSummary" style="color: #94a3b8; font-size: 14px; margin-bottom: 8px;"></p>
          <p id="shareTimestamp" style="color: #64748b; font-size: 12px;"></p>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <span>Enable sharing</span>
          <label style="position: relative; display: inline-block; width: 50px; height: 28px;">
            <input type="checkbox" id="shareToggle" onchange="toggleShare()" style="opacity: 0; width: 0; height: 0;">
            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; border-radius: 28px; transition: 0.3s;"></span>
            <span id="shareToggleKnob" style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s;"></span>
          </label>
        </div>

        <div id="shareOptions" style="display: none;">
          <div style="margin-bottom: 16px;">
            <label style="font-size: 14px; color: #94a3b8; display: block; margin-bottom: 8px;">Link expires</label>
            <select id="shareExpiry" onchange="updateShareExpiry()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 14px;">
              <option value="0">Never</option>
              <option value="7">In 7 days</option>
              <option value="30">In 30 days</option>
              <option value="90">In 90 days</option>
            </select>
          </div>

          <div style="background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; gap: 8px;">
              <input type="text" id="shareUrl" readonly style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #f8fafc; font-size: 13px;">
              <button onclick="copyShareLink()" style="padding: 8px 16px; background: #2563eb; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">Copy</button>
            </div>
            <p id="shareCopyStatus" style="font-size: 12px; color: #64748b; margin-top: 8px; text-align: center;"></p>
          </div>

          <div style="display: flex; justify-content: space-between; font-size: 13px; color: #64748b;">
            <span>Views: <span id="shareViewCount">0</span></span>
            <span id="shareExpiryText"></span>
          </div>
        </div>

        <!-- Family Sharing Section -->
        <div id="familyShareSection" style="display: none; border-top: 1px solid #334155; padding-top: 16px; margin-top: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <span>Share with family</span>
            <label style="position: relative; display: inline-block; width: 50px; height: 28px;">
              <input type="checkbox" id="familyShareToggle" onchange="toggleFamilyShare()" style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; border-radius: 28px; transition: 0.3s;"></span>
              <span id="familyShareToggleKnob" style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s;"></span>
            </label>
          </div>
          <p style="font-size: 12px; color: #64748b;">Shared entries appear in your family's feed after syncing.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    let recording = false;
    let mediaRecorder = null;
    let chunks = [];
    let context = 'auto';
    let digestMode = 'day';
    let loadedPlugins = [];

    // Load plugins dynamically
    async function loadPlugins() {
      try {
        const res = await fetch('/api/plugins');
        const plugins = await res.json();
        loadedPlugins = plugins;

        const tabsContainer = document.getElementById('tabsContainer');
        const pluginContainer = document.getElementById('pluginTabsContainer');

        plugins.forEach(plugin => {
          // Add tab button
          const tabBtn = document.createElement('button');
          tabBtn.className = 'tab-btn';
          tabBtn.onclick = () => showTab(`plugin-${plugin.name}`);
          tabBtn.textContent = plugin.label;
          tabsContainer.appendChild(tabBtn);

          // Add tab content with iframe
          const tabContent = document.createElement('div');
          tabContent.id = `plugin-${plugin.name}Tab`;
          tabContent.style.display = 'none';
          tabContent.innerHTML = `
            <iframe
              class="plugin-frame"
              src="/plugins/${plugin.name}/index.html"
              title="${plugin.label}"
            ></iframe>
          `;
          pluginContainer.appendChild(tabContent);
        });

        console.log(`Loaded ${plugins.length} plugin(s)`);
      } catch (e) {
        console.log('No plugins loaded:', e.message);
      }
    }

    function setDigestMode(mode) {
      digestMode = mode;
      document.getElementById('digestDayBtn').classList.toggle('active', mode === 'day');
      document.getElementById('digestWeekBtn').classList.toggle('active', mode === 'week');
      document.getElementById('digestTitle').textContent = mode === 'day' ? 'Daily Digest' : 'Weekly Digest';
    }

    // Update datetime
    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // Context buttons
    document.querySelectorAll('.ctx-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.ctx-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        context = btn.dataset.ctx;
      };
    });

    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="showTab('${tab}')"]`).classList.add('active');

      // Hide all core tabs
      document.getElementById('captureTab').style.display = 'none';
      document.getElementById('journalTab').style.display = 'none';
      document.getElementById('searchTab').style.display = 'none';
      document.getElementById('digestTab').style.display = 'none';
      document.getElementById('patternsTab').style.display = 'none';
      document.getElementById('familyTab').style.display = 'none';

      // Hide all plugin tabs
      loadedPlugins.forEach(p => {
        const pluginTab = document.getElementById(`plugin-${p.name}Tab`);
        if (pluginTab) pluginTab.style.display = 'none';
      });

      // Show selected tab
      if (tab.startsWith('plugin-')) {
        const pluginTab = document.getElementById(`${tab}Tab`);
        if (pluginTab) pluginTab.style.display = 'block';
      } else {
        const tabEl = document.getElementById(`${tab}Tab`);
        if (tabEl) tabEl.style.display = 'block';
      }

      if (tab === 'journal') loadEntries();
      if (tab === 'digest') {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('digestDate').value = today;
      }
      if (tab === 'family') {
        loadFamilyFeed();
        clearUnreadBadge();
      }
    }

    // Record button
    document.getElementById('recordBtn').onclick = async () => {
      const btn = document.getElementById('recordBtn');
      const status = document.getElementById('recordStatus');

      if (!recording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          chunks = [];

          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = uploadRecording;
          mediaRecorder.start();

          recording = true;
          btn.classList.add('recording');
          btn.innerHTML = '<span class="icon">‚èπÔ∏è</span><span>RECORDING...</span>';
          status.textContent = 'Listening...';
        } catch (err) {
          status.textContent = 'Microphone access denied';
          console.error(err);
        }
      } else {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        recording = false;
        btn.classList.remove('recording');
        btn.innerHTML = '<span class="icon">üé§</span><span>TAP TO RECORD</span>';
        status.textContent = 'Processing...';
      }
    };

    async function uploadRecording() {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const form = new FormData();
      form.append('audio', blob, 'recording.webm');
      form.append('timestamp', new Date().toISOString());
      form.append('device', 'web');
      form.append('context', context);

      try {
        const res = await fetch('/api/lifelog/ingest', { method: 'POST', body: form });
        const data = await res.json();
        document.getElementById('recordStatus').textContent = data.success ? '‚úì Saved!' : '‚úó Failed';
        loadStats();
      } catch (e) {
        document.getElementById('recordStatus').textContent = '‚úó Network error';
      }

      setTimeout(() => {
        document.getElementById('recordStatus').textContent = 'Ready to capture your thoughts';
      }, 2000);
    }

    // Load stats
    async function loadStats() {
      try {
        const status = await fetch('/api/status').then(r => r.json());
        document.getElementById('totalCount').textContent = status.total || 0;
        document.getElementById('todayCount').textContent = status.today || 0;

        // Update status bar with Whisper info
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        if (status.whisperEnabled) {
          statusDot.style.background = '#22c55e';
          statusText.textContent = 'Whisper';
        } else {
          statusDot.style.background = '#f59e0b';
          statusText.textContent = 'Whisper Off';
        }

        // Update Claude status
        const claudeDot = document.getElementById('claudeDot');
        const claudeText = document.getElementById('claudeText');
        if (status.claudeEnabled) {
          claudeDot.style.background = '#a78bfa';
          claudeText.textContent = 'Claude';
        } else {
          claudeDot.style.background = '#64748b';
          claudeText.textContent = 'Claude Off';
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // Load entries
    async function loadEntries() {
      try {
        const entries = await fetch('/api/lifelog/entries').then(r => r.json());
        const list = document.getElementById('entriesList');

        if (entries.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="icon">üéôÔ∏è</div>
              <p>No notes yet.<br>Record your first voice note!</p>
            </div>
          `;
          return;
        }

        list.innerHTML = entries.slice().reverse().map(e => `
          <div class="entry-item" data-id="${e.id}">
            <div class="entry-header">
              <span class="entry-context">${getContextEmoji(e.context)} ${e.context}</span>
              <span class="entry-time">${formatTime(e.timestamp)}</span>
            </div>
            <div class="entry-text">${e.transcript || '<em style="color:#64748b">Audio note (transcription pending)</em>'}</div>
            ${e.summary ? `<div class="entry-summary">üí° ${e.summary}</div>` : ''}
            ${e.sentiment || e.topics ? `
              <div class="entry-meta">
                ${e.sentiment ? `<span class="entry-tag ${e.sentiment}">${e.mood || e.sentiment}</span>` : ''}
                ${e.topics ? e.topics.map(t => `<span class="entry-tag">${t}</span>`).join('') : ''}
              </div>
            ` : ''}
            <div class="entry-actions">
              ${!e.transcript && e.audioPath ? `<button class="entry-btn transcribe" onclick="transcribeEntry(${e.id})">Transcribe</button>` : ''}
              ${e.transcript && !e.summary ? `<button class="entry-btn analyze" onclick="analyzeEntry(${e.id})">Analyze</button>` : ''}
              <button class="entry-btn share" onclick="openShareModal(${e.id})">Share</button>
              <button class="entry-btn delete" onclick="deleteEntry(${e.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function getContextEmoji(ctx) {
      const emojis = { auto: 'üìù', health: 'üè•', idea: 'üí°', personal: 'üè†', work: 'üíº' };
      return emojis[ctx] || 'üìù';
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    async function deleteEntry(id) {
      if (!confirm('Delete this note?')) return;
      try {
        await fetch(`/api/lifelog/entries/${id}`, { method: 'DELETE' });
        loadEntries();
        loadStats();
      } catch (e) {
        alert('Failed to delete');
      }
    }

    async function transcribeEntry(id) {
      const btn = document.querySelector(`[data-id="${id}"] .transcribe`);
      if (btn) {
        btn.textContent = 'Transcribing...';
        btn.disabled = true;
      }
      try {
        const res = await fetch(`/api/lifelog/transcribe/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadEntries();
        } else {
          alert('Transcription failed: ' + (data.error || 'Unknown error'));
          if (btn) {
            btn.textContent = 'Transcribe';
            btn.disabled = false;
          }
        }
      } catch (e) {
        alert('Transcription failed');
        if (btn) {
          btn.textContent = 'Transcribe';
          btn.disabled = false;
        }
      }
    }

    async function analyzeEntry(id) {
      const btn = document.querySelector(`[data-id="${id}"] .analyze`);
      if (btn) {
        btn.textContent = 'Analyzing...';
        btn.disabled = true;
      }
      try {
        const res = await fetch(`/api/lifelog/analyze/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadEntries();
        } else {
          alert('Analysis failed: ' + (data.error || 'Unknown error'));
          if (btn) {
            btn.textContent = 'Analyze';
            btn.disabled = false;
          }
        }
      } catch (e) {
        alert('Analysis failed');
        if (btn) {
          btn.textContent = 'Analyze';
          btn.disabled = false;
        }
      }
    }

    async function loadDigest() {
      const dateStr = document.getElementById('digestDate').value;
      if (!dateStr) {
        alert('Please select a date');
        return;
      }

      const content = document.getElementById('digestContent');
      const isWeekly = digestMode === 'week';
      content.innerHTML = `<div class="empty-state"><div class="icon">‚è≥</div><p>Generating your ${isWeekly ? 'weekly' : 'daily'} digest...</p></div>`;

      try {
        const endpoint = isWeekly ? `/api/lifelog/digest/week/${dateStr}?ai=true` : `/api/lifelog/digest/${dateStr}?ai=true`;
        const res = await fetch(endpoint);
        const data = await res.json();

        if (data.totalEntries === 0) {
          content.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>No entries for this ${isWeekly ? 'week' : 'date'}.</p></div>`;
          return;
        }

        let html = `<div class="digest-stats">
          <div class="digest-stat">üìù ${data.totalEntries} entries</div>
          ${isWeekly ? `<div class="digest-stat">üìÖ ${data.daysWithEntries} days</div>` : ''}
          <div class="digest-stat">üí¨ ${data.topics?.length || 0} topics</div>
          <div class="digest-stat">‚úÖ ${data.actionItems?.length || 0} actions</div>
        </div>`;

        if (isWeekly && data.weekStart) {
          html += `<p style="color: #64748b; font-size: 13px; margin-bottom: 12px;">Week of ${data.weekStart} to ${data.weekEnd}</p>`;
        }

        if (data.ai) {
          html += `
            <div class="digest-title">${data.ai.title}</div>
            <span class="digest-mood">${data.ai.overallMood}</span>
            <div class="digest-narrative">${data.ai.narrative}</div>
          `;

          // Weekly-specific sections
          if (isWeekly && data.ai.topThemes?.length) {
            html += `<div class="digest-section">
              <h3>üéØ Top Themes</h3>
              <div class="entry-meta">${data.ai.topThemes.map(t => `<span class="entry-tag">${t}</span>`).join('')}</div>
            </div>`;
          }

          if (isWeekly && data.ai.wins?.length) {
            html += `<div class="digest-section">
              <h3>üèÜ Wins</h3>
              <ul class="digest-list">${data.ai.wins.map(w => `<li>${w}</li>`).join('')}</ul>
            </div>`;
          }

          if (isWeekly && data.ai.challenges?.length) {
            html += `<div class="digest-section">
              <h3>üí™ Challenges</h3>
              <ul class="digest-list">${data.ai.challenges.map(c => `<li>${c}</li>`).join('')}</ul>
            </div>`;
          }

          if (isWeekly && data.ai.patterns?.length) {
            html += `<div class="digest-section">
              <h3>üîÑ Patterns Noticed</h3>
              <ul class="digest-list">${data.ai.patterns.map(p => `<li>${p}</li>`).join('')}</ul>
            </div>`;
          }

          // Daily highlights (only for daily digest)
          if (!isWeekly && data.ai.highlights?.length) {
            html += `<div class="digest-section">
              <h3>‚ú® Highlights</h3>
              <ul class="digest-list">${data.ai.highlights.map(h => `<li>${h}</li>`).join('')}</ul>
            </div>`;
          }

          if (data.ai.actionItems?.length) {
            html += `<div class="digest-section">
              <h3>üìã Action Items</h3>
              <ul class="digest-list">${data.ai.actionItems.map(a => `<li>${a}</li>`).join('')}</ul>
            </div>`;
          }

          // Reflection section
          const reflectionText = data.ai.reflection || data.ai.weekAhead;
          if (reflectionText) {
            html += `<div class="digest-reflection">üí≠ ${reflectionText}</div>`;
          }
        } else if (data.aiError) {
          html += `<p style="color: #f59e0b;">AI digest unavailable: ${data.aiError}</p>`;
          if (data.topics?.length) {
            html += `<div class="digest-section"><h3>Topics</h3><div class="entry-meta">${data.topics.map(t => `<span class="entry-tag">${t}</span>`).join('')}</div></div>`;
          }
        } else {
          html += '<p style="color: #94a3b8;">Set ANTHROPIC_API_KEY to enable AI-powered digests.</p>';
        }

        content.innerHTML = html;
      } catch (e) {
        console.error(e);
        content.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><p>Failed to load digest.</p></div>';
      }
    }

    async function semanticSearch() {
      const query = document.getElementById('searchQuery').value.trim();
      if (!query) {
        alert('Please enter a search query');
        return;
      }

      const results = document.getElementById('searchResults');
      results.innerHTML = '<div class="empty-state"><div class="icon">‚è≥</div><p>Searching...</p></div>';

      try {
        const res = await fetch(`/api/lifelog/search/semantic?q=${encodeURIComponent(query)}&limit=10`);
        const data = await res.json();

        if (data.error) {
          results.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>${data.error}</p></div>`;
          return;
        }

        if (!data.results || data.results.length === 0) {
          results.innerHTML = `<div class="empty-state"><div class="icon">üîç</div><p>No matching entries found.<br>${data.message || ''}</p></div>`;
          return;
        }

        let html = `<p style="color: #64748b; font-size: 13px; margin-bottom: 12px;">Found ${data.results.length} results (${data.totalEmbedded} entries indexed)</p>`;

        html += data.results.map(e => `
          <div class="entry-item">
            <div class="entry-header">
              <span class="entry-context">${getContextEmoji(e.context)} ${e.context}</span>
              <span class="entry-time">${formatTime(e.timestamp)}</span>
            </div>
            <div style="font-size: 12px; color: #a78bfa; margin-bottom: 4px;">Match: ${(e.similarity * 100).toFixed(1)}%</div>
            <div class="entry-text">${e.summary || e.transcript || '(no content)'}</div>
            ${e.topics?.length ? `<div class="entry-meta">${e.topics.map(t => `<span class="entry-tag">${t}</span>`).join('')}</div>` : ''}
          </div>
        `).join('');

        results.innerHTML = html;
      } catch (e) {
        console.error(e);
        results.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><p>Search failed.</p></div>';
      }
    }

    // Allow Enter key to trigger search
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchQuery');
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') semanticSearch();
        });
      }
    });


    async function loadPatterns() {
      const container = document.getElementById('patternsContent');
      const days = document.getElementById('patternDays').value;
      const ai = document.getElementById('patternAI').checked;

      container.innerHTML = '<div class="loading">Analyzing patterns...</div>';

      try {
        const res = await fetch('/api/lifelog/patterns?days=' + days + '&ai=' + ai);
        const data = await res.json();

        if (data.error || !data.patterns) {
          container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>' + (data.error || 'No patterns found') + '</p></div>';
          return;
        }

        const p = data.patterns;
        let html = '';

        // Summary stats
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px;">';
        html += '<div style="background: #1e293b; padding: 16px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold; color: #3b82f6;">' + p.totalEntries + '</div><div style="color: #94a3b8; font-size: 12px;">Entries</div></div>';
        html += '<div style="background: #1e293b; padding: 16px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold; color: ' + (p.avgSentiment >= 0.6 ? '#22c55e' : p.avgSentiment >= 0.4 ? '#eab308' : '#ef4444') + ';">' + Math.round(p.avgSentiment * 100) + '%</div><div style="color: #94a3b8; font-size: 12px;">Avg Sentiment</div></div>';
        html += '<div style="background: #1e293b; padding: 16px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold; color: #a855f7;">' + p.topTopics.length + '</div><div style="color: #94a3b8; font-size: 12px;">Topics</div></div>';
        html += '</div>';

        // Top topics
        if (p.topTopics.length > 0) {
          html += '<div style="margin-bottom: 20px;"><h3 style="color: #f8fafc; margin-bottom: 12px;">Top Topics</h3>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
          p.topTopics.forEach(t => {
            html += '<span style="background: #3b82f6; padding: 6px 12px; border-radius: 20px; font-size: 14px;">' + t.topic + ' (' + t.count + ')</span>';
          });
          html += '</div></div>';
        }

        // Mood distribution
        if (p.moodDistribution.length > 0) {
          html += '<div style="margin-bottom: 20px;"><h3 style="color: #f8fafc; margin-bottom: 12px;">Mood Distribution</h3>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
          p.moodDistribution.forEach(m => {
            html += '<span style="background: #6366f1; padding: 6px 12px; border-radius: 20px; font-size: 14px;">' + m.mood + ' (' + m.count + ')</span>';
          });
          html += '</div></div>';
        }

        // Time patterns
        if (p.timePatterns.length > 0) {
          html += '<div style="margin-bottom: 20px;"><h3 style="color: #f8fafc; margin-bottom: 12px;">Most Active Times</h3>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
          p.timePatterns.forEach(t => {
            html += '<span style="background: #0d9488; padding: 6px 12px; border-radius: 20px; font-size: 14px;">' + t.timeLabel + ' (' + t.count + ')' + (t.commonMood ? ' - ' + t.commonMood : '') + '</span>';
          });
          html += '</div></div>';
        }

        // Day of week patterns
        if (p.dayOfWeekPatterns.length > 0) {
          html += '<div style="margin-bottom: 20px;"><h3 style="color: #f8fafc; margin-bottom: 12px;">Most Active Days</h3>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
          p.dayOfWeekPatterns.forEach(d => {
            html += '<span style="background: #f59e0b; padding: 6px 12px; border-radius: 20px; font-size: 14px; color: #000;">' + d.day + ' (' + d.count + ')</span>';
          });
          html += '</div></div>';
        }

        // AI insights
        if (data.ai) {
          html += '<div style="background: linear-gradient(135deg, #1e1b4b, #312e81); padding: 20px; border-radius: 12px; margin-top: 20px;">';
          html += '<h3 style="color: #c4b5fd; margin-bottom: 12px;">AI Insights</h3>';
          html += '<p style="color: #e0e7ff; line-height: 1.6; margin-bottom: 16px;">' + data.ai.summary + '</p>';

          if (data.ai.insights && data.ai.insights.length > 0) {
            html += '<div style="margin-bottom: 12px;"><strong style="color: #a5b4fc;">Insights:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
            data.ai.insights.forEach(i => { html += '<li style="color: #e0e7ff; margin: 4px 0;">' + i + '</li>'; });
            html += '</ul></div>';
          }

          if (data.ai.strengths && data.ai.strengths.length > 0) {
            html += '<div style="margin-bottom: 12px;"><strong style="color: #86efac;">Strengths:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
            data.ai.strengths.forEach(s => { html += '<li style="color: #e0e7ff; margin: 4px 0;">' + s + '</li>'; });
            html += '</ul></div>';
          }

          if (data.ai.suggestions && data.ai.suggestions.length > 0) {
            html += '<div><strong style="color: #fcd34d;">Suggestions:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
            data.ai.suggestions.forEach(s => { html += '<li style="color: #e0e7ff; margin: 4px 0;">' + s + '</li>'; });
            html += '</ul></div>';
          }

          html += '</div>';
        }

        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading patterns</p></div>';
      }
    }

    // ============ BEHAVIORAL FEATURES ============

    // Fresh Start localStorage keys
    const FRESH_START_DISMISSED = 'kinship_freshStart_dismissed';

    // Progress Data
    let progressData = null;

    // Load weekly progress
    async function loadProgress() {
      try {
        const data = await fetch('/api/lifelog/streak').then(r => r.json());
        progressData = data;
        renderProgress();
      } catch (e) {
        console.error('Failed to load progress:', e);
      }
    }

    function renderProgress() {
      if (!progressData) return;

      const { weekDays, daysWithEntries, currentStreak, weekProgress, hasTodayEntry } = progressData;

      // Update streak badge
      document.getElementById('progressStreak').textContent = currentStreak;

      // Render day indicators
      const weekDaysEl = document.getElementById('weekDays');
      weekDaysEl.innerHTML = weekDays.map(day => {
        let dotClass = 'day-dot';
        let content = '';

        if (day.isFuture) {
          dotClass += ' future';
        } else if (day.hasEntry) {
          dotClass += ' filled';
          content = '‚úì';
        } else {
          dotClass += ' empty';
        }

        if (day.isToday) {
          dotClass += ' today';
        }

        return `
          <div class="day-indicator">
            <span class="day-name">${day.dayName}</span>
            <div class="${dotClass}">${content}</div>
          </div>
        `;
      }).join('');

      // Update progress bar
      document.getElementById('weekProgressBar').style.width = `${weekProgress}%`;

      // Update progress message
      const messageEl = document.getElementById('progressMessage');
      if (daysWithEntries === 7) {
        messageEl.textContent = 'üéâ Perfect week! You captured every day!';
        messageEl.style.color = '#22c55e';
      } else if (daysWithEntries >= 5) {
        messageEl.textContent = `Amazing! ${daysWithEntries}/7 days. Keep it up!`;
        messageEl.style.color = '#a78bfa';
      } else if (!hasTodayEntry) {
        const remaining = 7 - daysWithEntries;
        messageEl.textContent = `${daysWithEntries}/7 days this week. ${remaining} more to go!`;
        messageEl.style.color = '#94a3b8';
      } else {
        messageEl.textContent = `${daysWithEntries}/7 days. You're building a great habit!`;
        messageEl.style.color = '#94a3b8';
      }

      // Also update the streak in the stats grid
      document.getElementById('streakCount').textContent = currentStreak;
    }

    // ============ ONE-TAP MOOD ============

    let selectedMoodBtn = null;

    function selectMood(btn) {
      // Deselect previous
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));

      // Select new
      btn.classList.add('selected');
      selectedMoodBtn = btn;

      // Show note section
      document.getElementById('moodNoteSection').style.display = 'block';
      document.getElementById('moodNote').focus();
    }

    function cancelMood() {
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      selectedMoodBtn = null;
      document.getElementById('moodNoteSection').style.display = 'none';
      document.getElementById('moodNote').value = '';
      document.getElementById('moodStatus').textContent = '';
    }

    async function saveMood() {
      if (!selectedMoodBtn) {
        alert('Please select a mood first');
        return;
      }

      const mood = selectedMoodBtn.dataset.mood;
      const sentimentScore = parseFloat(selectedMoodBtn.dataset.score);
      const note = document.getElementById('moodNote').value.trim();

      document.getElementById('moodStatus').textContent = 'Saving...';

      try {
        const res = await fetch('/api/lifelog/mood', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mood,
            sentimentScore,
            note: note || null,
            context: context
          })
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('moodStatus').textContent = '‚úì Mood logged!';
          document.getElementById('moodStatus').style.color = '#22c55e';

          // Reset UI
          setTimeout(() => {
            cancelMood();
            document.getElementById('moodStatus').style.color = '#64748b';
          }, 2000);

          // Refresh stats and progress
          loadStats();
          loadProgress();
        } else {
          throw new Error(data.error);
        }
      } catch (e) {
        document.getElementById('moodStatus').textContent = '‚úó Failed to save';
        document.getElementById('moodStatus').style.color = '#ef4444';
      }
    }

    // ============ FRESH START EFFECT ============

    function checkFreshStart() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const dismissed = localStorage.getItem(FRESH_START_DISMISSED);

      // Don't show if already dismissed today
      if (dismissed === today) return null;

      const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday
      const dayOfMonth = now.getDate();

      // Monday - fresh week
      if (dayOfWeek === 1) {
        return {
          type: 'monday',
          title: 'Fresh Week!',
          message: 'A new week begins. Would you like to set an intention?',
          emoji: 'üåÖ'
        };
      }

      // 1st of month
      if (dayOfMonth === 1) {
        return {
          type: 'month',
          title: 'New Month, New Chapter',
          message: 'What would you like to focus on this month?',
          emoji: 'üìÖ'
        };
      }

      return null;
    }

    async function checkReturnGap() {
      try {
        const entries = await fetch('/api/lifelog/entries').then(r => r.json());
        if (entries.length === 0) return null;

        const lastEntry = entries[entries.length - 1];
        const lastDate = new Date(lastEntry.timestamp);
        const now = new Date();
        const daysDiff = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

        if (daysDiff >= 3) {
          return {
            type: 'return',
            title: 'Welcome Back!',
            message: `It's been ${daysDiff} days. Good to see you again. What's on your mind?`,
            emoji: 'üëã'
          };
        }
      } catch (e) {
        console.error('Error checking return gap:', e);
      }
      return null;
    }

    async function showFreshStartIfNeeded() {
      // Check temporal landmarks first
      let prompt = checkFreshStart();

      // If no temporal landmark, check return gap
      if (!prompt) {
        prompt = await checkReturnGap();
      }

      if (prompt) {
        document.getElementById('freshStartEmoji').textContent = prompt.emoji;
        document.getElementById('freshStartTitle').textContent = prompt.title;
        document.getElementById('freshStartMessage').textContent = prompt.message;
        document.getElementById('freshStartModal').style.display = 'flex';
      }
    }

    function dismissFreshStart() {
      const today = new Date().toISOString().split('T')[0];
      localStorage.setItem(FRESH_START_DISMISSED, today);
      document.getElementById('freshStartModal').style.display = 'none';
    }

    async function saveIntention() {
      const intention = document.getElementById('intentionInput').value.trim();
      if (!intention) {
        alert('Please enter your intention');
        return;
      }

      try {
        const res = await fetch('/api/lifelog/mood', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mood: 'üéØ',
            sentimentScore: 0.8,
            note: `My intention: ${intention}`,
            context: 'personal'
          })
        });

        const data = await res.json();
        if (data.success) {
          const today = new Date().toISOString().split('T')[0];
          localStorage.setItem(FRESH_START_DISMISSED, today);
          document.getElementById('freshStartModal').style.display = 'none';
          document.getElementById('intentionInput').value = '';
          loadStats();
          loadProgress();
        }
      } catch (e) {
        alert('Failed to save intention');
      }
    }

    // ============ SETTINGS ============

    async function openSettings() {
      document.getElementById('settingsModal').style.display = 'flex';

      // Load current status
      try {
        const status = await fetch('/api/status').then(r => r.json());

        document.getElementById('settingsWhisper').textContent = status.whisperEnabled ? '‚úì Enabled' : '‚úó Disabled';
        document.getElementById('settingsWhisper').style.color = status.whisperEnabled ? '#22c55e' : '#ef4444';

        document.getElementById('settingsClaude').textContent = status.claudeEnabled ? '‚úì Enabled' : '‚úó Disabled';
        document.getElementById('settingsClaude').style.color = status.claudeEnabled ? '#a78bfa' : '#ef4444';

        document.getElementById('settingsTotal').textContent = status.total || 0;
      } catch (e) {
        console.error('Failed to load settings status:', e);
      }
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    // ============ SHARING FUNCTIONS ============

    let currentShareEntryId = null;

    async function openShareModal(entryId) {
      currentShareEntryId = entryId;
      document.getElementById('shareModal').style.display = 'flex';

      // Get entry details
      const entries = await fetch('/api/lifelog/entries').then(r => r.json());
      const entry = entries.find(e => e.id === entryId);

      if (entry) {
        document.getElementById('shareSummary').textContent = entry.summary || entry.transcript || 'Voice note';
        document.getElementById('shareTimestamp').textContent = formatTime(entry.timestamp);
      }

      // Get share status
      try {
        const status = await fetch(`/api/lifelog/entries/${entryId}/share`).then(r => r.json());

        const toggle = document.getElementById('shareToggle');
        const knob = document.getElementById('shareToggleKnob');
        const options = document.getElementById('shareOptions');

        toggle.checked = status.shared;
        if (status.shared) {
          knob.style.transform = 'translateX(22px)';
          knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#2563eb';
          options.style.display = 'block';
          document.getElementById('shareUrl').value = window.location.origin + status.shareUrl;
          document.getElementById('shareViewCount').textContent = status.shareViewCount || 0;
          document.getElementById('shareExpiryText').textContent = status.shareExpiresAt
            ? `Expires ${new Date(status.shareExpiresAt).toLocaleDateString()}`
            : '';
        } else {
          knob.style.transform = 'translateX(0)';
          knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#334155';
          options.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to load share status:', e);
      }
    }

    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      currentShareEntryId = null;
      document.getElementById('shareCopyStatus').textContent = '';
    }

    async function toggleShare() {
      const toggle = document.getElementById('shareToggle');
      const knob = document.getElementById('shareToggleKnob');
      const options = document.getElementById('shareOptions');
      const enabled = toggle.checked;

      // Update toggle visual
      if (enabled) {
        knob.style.transform = 'translateX(22px)';
        knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#2563eb';
      } else {
        knob.style.transform = 'translateX(0)';
        knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#334155';
      }

      try {
        const expiresIn = parseInt(document.getElementById('shareExpiry').value) || 0;
        const res = await fetch(`/api/lifelog/entries/${currentShareEntryId}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled, expiresIn })
        });
        const data = await res.json();

        if (data.success) {
          if (enabled) {
            options.style.display = 'block';
            document.getElementById('shareUrl').value = window.location.origin + data.shareUrl;
            document.getElementById('shareViewCount').textContent = '0';
            document.getElementById('shareExpiryText').textContent = data.expiresAt
              ? `Expires ${new Date(data.expiresAt).toLocaleDateString()}`
              : '';
          } else {
            options.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('Failed to toggle share:', e);
        alert('Failed to update sharing');
      }
    }

    async function updateShareExpiry() {
      if (!document.getElementById('shareToggle').checked) return;

      const expiresIn = parseInt(document.getElementById('shareExpiry').value) || 0;
      try {
        const res = await fetch(`/api/lifelog/entries/${currentShareEntryId}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: true, expiresIn })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('shareExpiryText').textContent = data.expiresAt
            ? `Expires ${new Date(data.expiresAt).toLocaleDateString()}`
            : '';
        }
      } catch (e) {
        console.error('Failed to update expiry:', e);
      }
    }

    function copyShareLink() {
      const url = document.getElementById('shareUrl').value;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('shareCopyStatus').textContent = 'Link copied!';
        document.getElementById('shareCopyStatus').style.color = '#22c55e';
        setTimeout(() => {
          document.getElementById('shareCopyStatus').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('shareCopyStatus').textContent = 'Failed to copy';
        document.getElementById('shareCopyStatus').style.color = '#ef4444';
      });
    }

    // Close share modal on overlay click
    document.getElementById('shareModal').addEventListener('click', (e) => {
      if (e.target.id === 'shareModal') closeShareModal();
    });

    async function embedAll() {
      if (!confirm('This will generate embeddings for all entries without them. Continue?')) return;

      try {
        const res = await fetch('/api/lifelog/embed-all', { method: 'POST' });
        const data = await res.json();
        alert(`Embedded ${data.embedded} entries. ${data.failed} failed.`);
      } catch (e) {
        alert('Failed to embed entries');
      }
    }

    function resetFreshStart() {
      localStorage.removeItem(FRESH_START_DISMISSED);
      alert('Fresh Start prompts will show again on next trigger (Monday, 1st of month, or after 3+ days away).');
    }

    async function saveOpenAIKey() {
      const key = document.getElementById('openaiKeyInput').value.trim();
      if (!key) {
        alert('Please enter an API key');
        return;
      }
      if (!key.startsWith('sk-')) {
        alert('OpenAI keys typically start with "sk-"');
        return;
      }

      try {
        const res = await fetch('/api/config/openai-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('openaiKeyInput').value = '';
          document.getElementById('settingsWhisper').textContent = '‚úì Enabled';
          document.getElementById('settingsWhisper').style.color = '#22c55e';
          loadStats();
        } else {
          alert('Failed to save key: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Failed to save key');
      }
    }

    async function saveAnthropicKey() {
      const key = document.getElementById('anthropicKeyInput').value.trim();
      if (!key) {
        alert('Please enter an API key');
        return;
      }
      if (!key.startsWith('sk-ant-')) {
        alert('Anthropic keys typically start with "sk-ant-"');
        return;
      }

      try {
        const res = await fetch('/api/config/anthropic-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('anthropicKeyInput').value = '';
          document.getElementById('settingsClaude').textContent = '‚úì Enabled';
          document.getElementById('settingsClaude').style.color = '#a78bfa';
          loadStats();
        } else {
          alert('Failed to save key: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Failed to save key');
      }
    }

    // Close settings on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSettings();
        document.getElementById('freshStartModal').style.display = 'none';
      }
    });

    // Close modals when clicking overlay
    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target.id === 'settingsModal') closeSettings();
    });

    // Initial load
    loadStats();
    loadProgress();
    loadPlugins();
    checkIdentity();

    // Check for fresh start after a brief delay
    setTimeout(showFreshStartIfNeeded, 500);

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.warn('SW registration failed:', err));
    }

    // ============ IDENTITY & FAMILY FUNCTIONS ============

    let currentIdentity = null;
    let currentFamily = null;
    let selectedProfileColor = '#3b82f6';
    let unreadFamilyCount = 0;
    let lastSeenFamilyEntryTime = localStorage.getItem('lastSeenFamilyEntry') || '1970-01-01';

    // Toast notification system
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span style="font-size: 18px;">${type === 'success' ? '‚úì' : type === 'warning' ? '‚ö†' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);

      // Remove after 4 seconds
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Unread badge management
    function updateUnreadBadge(count) {
      unreadFamilyCount += count;
      const badge = document.getElementById('familyUnreadBadge');
      if (unreadFamilyCount > 0) {
        badge.textContent = unreadFamilyCount > 99 ? '99+' : unreadFamilyCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function clearUnreadBadge() {
      unreadFamilyCount = 0;
      document.getElementById('familyUnreadBadge').style.display = 'none';
      localStorage.setItem('lastSeenFamilyEntry', new Date().toISOString());
    }

    // Get initials from name
    function getInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    async function checkIdentity() {
      try {
        const res = await fetch('/api/identity');
        currentIdentity = await res.json();

        // If no name set, show profile setup modal
        if (currentIdentity.needsSetup) {
          document.getElementById('profileModal').style.display = 'flex';
        }

        // Load family status
        await loadFamilyStatus();
      } catch (e) {
        console.error('Error checking identity:', e);
      }
    }

    async function loadFamilyStatus() {
      try {
        const res = await fetch('/api/family');
        currentFamily = await res.json();

        // Show/hide family tab based on family status
        const familyTabBtn = document.getElementById('familyTabBtn');
        const familySetupCard = document.getElementById('familySetupCard');
        const familyInfoCard = document.getElementById('familyInfoCard');
        const familyShareSection = document.getElementById('familyShareSection');

        const familyDigestCard = document.getElementById('familyDigestCard');

        if (currentFamily.hasFamily) {
          familyTabBtn.style.display = 'block';
          familySetupCard.style.display = 'none';
          familyInfoCard.style.display = 'block';
          familyShareSection.style.display = 'block';
          familyDigestCard.style.display = 'block';

          // Update family info
          document.getElementById('familyDisplayName').textContent = currentFamily.familyName;

          // Update members list
          const membersList = document.getElementById('familyMembersList');
          membersList.innerHTML = currentFamily.members.map(m =>
            `<span style="padding: 6px 12px; background: ${m.color || '#334155'}; border-radius: 16px; font-size: 13px;">${m.name}</span>`
          ).join('');

          // Update last sync time
          if (currentFamily.lastSyncAt) {
            document.getElementById('lastSyncText').textContent = 'Last sync: ' + new Date(currentFamily.lastSyncAt).toLocaleString();
          }

          // Set digest date to today
          document.getElementById('familyDigestDate').value = new Date().toISOString().split('T')[0];

          // Load family feed
          loadFamilyFeed();
        } else {
          familyTabBtn.style.display = 'block';
          familySetupCard.style.display = 'block';
          familyInfoCard.style.display = 'none';
          familyShareSection.style.display = 'none';
          familyDigestCard.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading family status:', e);
      }
    }

    async function loadFamilyFeed() {
      try {
        const res = await fetch('/api/lifelog/family-feed');
        const data = await res.json();

        const container = document.getElementById('familyFeed');

        if (!data.entries || data.entries.length === 0) {
          container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No shared entries yet. Share some entries with your family!</p>';
          return;
        }

        // Check for new entries since last seen
        const newEntries = data.entries.filter(e => !e.isOwn && e.timestamp > lastSeenFamilyEntryTime);
        if (newEntries.length > 0 && document.getElementById('familyTab').style.display !== 'block') {
          updateUnreadBadge(newEntries.length);
        }

        container.innerHTML = data.entries.map(e => {
          const time = new Date(e.timestamp).toLocaleString('en-US', {
            month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
          });
          const initials = getInitials(e.ownerName);
          const isNew = !e.isOwn && e.timestamp > lastSeenFamilyEntryTime;

          return `
            <div style="background: #0f172a; border-radius: 12px; padding: 16px; margin-bottom: 12px; ${isNew ? 'border: 1px solid #3b82f6;' : ''}">
              <div style="display: flex; gap: 12px;">
                <div class="member-avatar" style="background: ${e.ownerColor || '#3b82f6'};">${initials}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-weight: 600; color: ${e.ownerColor || '#3b82f6'};">
                      ${e.ownerName || 'Unknown'}${e.isOwn ? ' <span style="color: #64748b; font-weight: normal;">(you)</span>' : ''}
                      ${isNew ? '<span style="background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">NEW</span>' : ''}
                    </span>
                    <span style="font-size: 12px; color: #64748b;">${time}</span>
                  </div>
                  <p style="color: #f8fafc; margin-bottom: 8px; line-height: 1.5;">${e.summary || e.transcript || 'Voice note'}</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    ${e.mood ? `<span style="padding: 4px 10px; background: #334155; border-radius: 12px; font-size: 12px;">${e.mood}</span>` : ''}
                    ${e.context && e.context !== 'auto' ? `<span style="padding: 4px 10px; background: #1e3a5f; border-radius: 12px; font-size: 12px; color: #93c5fd;">${e.context}</span>` : ''}
                    ${e.sentiment ? `<span style="padding: 4px 10px; background: ${e.sentiment === 'positive' ? '#14532d' : e.sentiment === 'negative' ? '#7f1d1d' : '#334155'}; border-radius: 12px; font-size: 12px; color: ${e.sentiment === 'positive' ? '#86efac' : e.sentiment === 'negative' ? '#fca5a5' : '#94a3b8'};">${e.sentiment}</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Error loading family feed:', e);
      }
    }

    async function loadFamilyDigest() {
      const date = document.getElementById('familyDigestDate').value;
      const container = document.getElementById('familyDigestContent');

      if (!date) {
        container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Select a date to view family digest</p>';
        return;
      }

      container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Loading family digest...</p>';

      try {
        const res = await fetch(`/api/family/digest/week/${date}?ai=true`);
        const data = await res.json();

        if (data.error) {
          container.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px;">${data.error}</p>`;
          return;
        }

        let html = `
          <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #334155;">
            <p style="color: #64748b; font-size: 12px;">Week of ${data.weekStart} to ${data.weekEnd}</p>
            <p style="color: #94a3b8; font-size: 13px;">${data.totalEntries} entries from ${data.memberCount} family members</p>
          </div>
        `;

        if (data.ai) {
          const ai = data.ai;
          html += `
            <h4 style="font-size: 18px; margin-bottom: 8px; color: #3b82f6;">${ai.title || 'Family Digest'}</h4>
            <p style="margin-bottom: 16px; white-space: pre-wrap; line-height: 1.6;">${ai.narrative || ''}</p>
          `;

          if (ai.familyThemes && ai.familyThemes.length) {
            html += `
              <div style="margin-bottom: 16px;">
                <h5 style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Family Themes</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${ai.familyThemes.map(t => `<span style="padding: 4px 12px; background: #1e3a5f; border-radius: 12px; font-size: 13px;">${t}</span>`).join('')}
                </div>
              </div>
            `;
          }

          if (ai.memberHighlights && ai.memberHighlights.length) {
            html += `
              <div style="margin-bottom: 16px;">
                <h5 style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Member Highlights</h5>
                ${ai.memberHighlights.map(h => `
                  <div style="background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                    <strong style="color: #3b82f6;">${h.name}</strong>
                    <p style="color: #f8fafc; margin-top: 4px;">${h.highlight}</p>
                  </div>
                `).join('')}
              </div>
            `;
          }

          if (ai.familyWins && ai.familyWins.length) {
            html += `
              <div style="margin-bottom: 16px;">
                <h5 style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Family Wins</h5>
                <ul style="margin: 0; padding-left: 20px; color: #22c55e;">
                  ${ai.familyWins.map(w => `<li style="margin-bottom: 4px;">${w}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          if (ai.lookingAhead) {
            html += `
              <div style="background: linear-gradient(135deg, #1e3a5f, #3b1f5f); border-radius: 12px; padding: 16px; margin-top: 16px;">
                <h5 style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Looking Ahead</h5>
                <p style="color: #f8fafc;">${ai.lookingAhead}</p>
              </div>
            `;
          }
        } else if (data.aiError) {
          html += `<p style="color: #f59e0b;">AI digest unavailable: ${data.aiError}</p>`;

          // Show basic stats
          if (data.byMember) {
            html += '<div style="margin-top: 16px;">';
            Object.entries(data.byMember).forEach(([name, info]) => {
              html += `
                <div style="background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                  <strong>${name}</strong>: ${info.count} entries
                  ${info.moods.length ? `<br><span style="color: #64748b; font-size: 12px;">Moods: ${info.moods.join(', ')}</span>` : ''}
                </div>
              `;
            });
            html += '</div>';
          }
        } else {
          html += '<p style="color: #64748b;">No AI digest available. Configure ANTHROPIC_API_KEY to enable.</p>';
        }

        container.innerHTML = html;
      } catch (e) {
        console.error('Error loading family digest:', e);
        container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error loading family digest</p>';
      }
    }

    // Profile color picker
    document.querySelectorAll('#profileColorPicker .color-dot').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('#profileColorPicker .color-dot').forEach(c => {
          c.style.borderColor = 'transparent';
          c.classList.remove('selected');
        });
        el.style.borderColor = '#fff';
        el.classList.add('selected');
        selectedProfileColor = el.dataset.color;
      });
    });

    async function saveProfile() {
      const name = document.getElementById('profileNameInput').value.trim();

      if (!name) {
        alert('Please enter your name');
        return;
      }

      try {
        const res = await fetch('/api/identity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ memberName: name, memberColor: selectedProfileColor })
        });

        if (res.ok) {
          document.getElementById('profileModal').style.display = 'none';
          currentIdentity = await res.json();
          loadFamilyStatus();
        } else {
          const err = await res.json();
          alert(err.error || 'Failed to save profile');
        }
      } catch (e) {
        alert('Error saving profile');
      }
    }

    function showCreateFamilyModal() {
      document.getElementById('createFamilyModal').style.display = 'flex';
    }

    function closeCreateFamilyModal() {
      document.getElementById('createFamilyModal').style.display = 'none';
    }

    function showJoinFamilyModal() {
      document.getElementById('joinFamilyModal').style.display = 'flex';
    }

    function closeJoinFamilyModal() {
      document.getElementById('joinFamilyModal').style.display = 'none';
    }

    async function createFamily() {
      const name = document.getElementById('createFamilyNameInput').value.trim();

      if (!name) {
        alert('Please enter a family name');
        return;
      }

      try {
        const res = await fetch('/api/family/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ familyName: name })
        });

        const data = await res.json();

        if (res.ok) {
          closeCreateFamilyModal();
          await loadFamilyStatus();
          showInviteModal();
        } else {
          alert(data.error || 'Failed to create family');
        }
      } catch (e) {
        alert('Error creating family');
      }
    }

    async function joinFamily() {
      const code = document.getElementById('joinFamilyCodeInput').value.trim();

      if (!code) {
        alert('Please enter an invite code');
        return;
      }

      try {
        const res = await fetch('/api/family/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inviteCode: code })
        });

        const data = await res.json();

        if (res.ok) {
          closeJoinFamilyModal();
          await loadFamilyStatus();
          alert('Welcome to ' + data.familyName + '!');
        } else {
          alert(data.error || 'Failed to join family');
        }
      } catch (e) {
        alert('Error joining family');
      }
    }

    async function showInviteModal() {
      try {
        const res = await fetch('/api/family/invite');
        const data = await res.json();

        document.getElementById('inviteCodeDisplay').value = data.inviteCode;

        // Create email link
        const subject = encodeURIComponent('Join My Kinship Family');
        const body = encodeURIComponent(`I'd like you to join my family on Kinship!\n\nFamily: ${data.familyName}\n\nTo join:\n1. Open Kinship on your device\n2. Go to the Family tab\n3. Click "Join Family"\n4. Paste this code: ${data.inviteCode}\n\nOr open this link: ${window.location.origin}/join-family?code=${data.inviteCode}`);
        document.getElementById('inviteEmailLink').href = `mailto:?subject=${subject}&body=${body}`;

        document.getElementById('inviteModal').style.display = 'flex';

        // Generate QR code
        const inviteUrl = `${window.location.origin}/join-family?code=${data.inviteCode}`;
        if (typeof QRCode !== 'undefined') {
          const canvas = document.getElementById('qrCodeCanvas');
          QRCode.toCanvas(canvas, inviteUrl, { width: 180, margin: 2 }, (error) => {
            if (error) console.error('QR code error:', error);
          });
        }
      } catch (e) {
        alert('Error generating invite');
      }
    }

    function closeInviteModal() {
      document.getElementById('inviteModal').style.display = 'none';
    }

    function copyInviteCode() {
      const code = document.getElementById('inviteCodeDisplay').value;
      const btn = document.getElementById('copyInviteBtn');
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'Copied!';
        btn.style.background = '#22c55e';
        setTimeout(() => {
          btn.textContent = 'Copy Invite Code';
          btn.style.background = '#2563eb';
        }, 2000);
      });
    }

    function showFamilySettings() {
      // Populate sync path
      document.getElementById('syncPathInput').value = currentFamily.syncPath || '';

      // Populate members
      const membersList = document.getElementById('familySettingsMembersList');
      membersList.innerHTML = currentFamily.members.map(m =>
        `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: #0f172a; border-radius: 8px; margin-bottom: 8px;">
          <span style="width: 12px; height: 12px; border-radius: 50%; background: ${m.color || '#334155'};"></span>
          <span>${m.name}</span>
          <span style="color: #64748b; font-size: 12px; margin-left: auto;">${m.role}</span>
        </div>`
      ).join('');

      document.getElementById('familySettingsModal').style.display = 'flex';
    }

    function closeFamilySettings() {
      document.getElementById('familySettingsModal').style.display = 'none';
    }

    function showLeaveFamilyConfirm() {
      document.getElementById('leaveFamilyName').textContent = currentFamily.familyName;
      closeFamilySettings();
      document.getElementById('leaveFamilyModal').style.display = 'flex';
    }

    function closeLeaveFamilyModal() {
      document.getElementById('leaveFamilyModal').style.display = 'none';
    }

    async function confirmLeaveFamily() {
      try {
        const res = await fetch('/api/family/leave', { method: 'DELETE' });
        const data = await res.json();

        if (res.ok) {
          closeLeaveFamilyModal();
          showToast('You have left the family', 'info');
          await loadFamilyStatus();
          showTab('capture');
        } else {
          showToast(data.error || 'Failed to leave family', 'warning');
        }
      } catch (e) {
        showToast('Error leaving family', 'warning');
      }
    }

    // Keep old function for backwards compatibility
    async function leaveFamily() {
      showLeaveFamilyConfirm();
    }

    async function syncFamily() {
      const syncPath = document.getElementById('syncPathInput')?.value || currentFamily.syncPath;

      if (!syncPath) {
        const path = prompt('Enter the sync folder path (e.g., C:\\Users\\Shared\\KinshipFamily or a Dropbox/Google Drive folder):');
        if (!path) return;
        currentFamily.syncPath = path;
      }

      // Update UI to show syncing
      setSyncStatus('syncing', 'Syncing...');
      const syncBtn = document.getElementById('syncFamilyBtn');
      syncBtn.disabled = true;
      document.getElementById('syncBtnText').textContent = 'Syncing...';

      try {
        // Export first
        const exportRes = await fetch('/api/sync/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ syncPath: syncPath || currentFamily.syncPath })
        });
        const exportData = await exportRes.json();

        if (!exportRes.ok) {
          setSyncStatus('error', 'Export failed');
          showToast(exportData.error || 'Export failed', 'warning');
          return;
        }

        // Then import
        const importRes = await fetch('/api/sync/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ syncPath: syncPath || currentFamily.syncPath })
        });
        const importData = await importRes.json();

        if (!importRes.ok) {
          setSyncStatus('error', 'Import failed');
          showToast(importData.error || 'Import failed', 'warning');
          return;
        }

        // Check for new entries and show notification
        if (importData.imported > 0) {
          showToast(`${importData.imported} new entries from family`, 'success');
          updateUnreadBadge(importData.imported);
        }

        // Show new members
        if (importData.newMembers && importData.newMembers.length > 0) {
          showToast(`${importData.newMembers.join(', ')} joined the family!`, 'info');
        }

        // Success
        setSyncStatus('success', 'Synced!');
        await loadFamilyStatus();
        await loadFamilyFeed();

        // Reset status after 3 seconds
        setTimeout(() => setSyncStatus('idle', 'Ready'), 3000);

      } catch (e) {
        setSyncStatus('error', 'Sync failed');
        showToast('Sync error: ' + e.message, 'warning');
      } finally {
        syncBtn.disabled = false;
        document.getElementById('syncBtnText').textContent = 'Sync Now';
      }
    }

    function setSyncStatus(status, text) {
      const indicator = document.getElementById('syncIndicator');
      const statusIcon = document.getElementById('syncStatusIcon');
      const statusText = document.getElementById('syncStatusText');

      indicator.className = 'sync-indicator ' + status;
      statusText.textContent = text;

      if (status === 'syncing') {
        statusIcon.innerHTML = '<span class="spinner"></span>';
      } else if (status === 'success') {
        statusIcon.textContent = '‚úì';
      } else if (status === 'error') {
        statusIcon.textContent = '‚úó';
      } else {
        statusIcon.textContent = '‚óè';
      }
    }

    async function toggleFamilyShare() {
      const toggle = document.getElementById('familyShareToggle');
      const knob = document.getElementById('familyShareToggleKnob');

      try {
        const res = await fetch(`/api/lifelog/entries/${currentShareEntryId}/family-share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: toggle.checked })
        });

        if (res.ok) {
          if (toggle.checked) {
            knob.style.transform = 'translateX(22px)';
            knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#7c3aed';
          } else {
            knob.style.transform = 'translateX(0)';
            knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#334155';
          }
        }
      } catch (e) {
        console.error('Failed to toggle family share:', e);
        toggle.checked = !toggle.checked;
      }
    }

    // Update openShareModal to also load family share status
    const originalOpenShareModal = openShareModal;
    async function openShareModal(entryId) {
      currentShareEntryId = entryId;
      document.getElementById('shareModal').style.display = 'flex';

      // Find entry
      const allEntries = await fetch('/api/lifelog/entries').then(r => r.json());
      const entry = allEntries.find(e => e.id === entryId);

      if (entry) {
        document.getElementById('shareSummary').textContent = entry.summary || entry.transcript || 'Voice note';
        document.getElementById('shareTimestamp').textContent = formatTime(entry.timestamp);
      }

      // Get public share status
      try {
        const status = await fetch(`/api/lifelog/entries/${entryId}/share`).then(r => r.json());

        const toggle = document.getElementById('shareToggle');
        const knob = document.getElementById('shareToggleKnob');
        const options = document.getElementById('shareOptions');

        toggle.checked = status.shared;
        if (status.shared) {
          knob.style.transform = 'translateX(22px)';
          knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#2563eb';
          options.style.display = 'block';
          document.getElementById('shareUrl').value = window.location.origin + status.shareUrl;
          document.getElementById('shareViewCount').textContent = status.shareViewCount || 0;
          document.getElementById('shareExpiryText').textContent = status.shareExpiresAt
            ? `Expires ${new Date(status.shareExpiresAt).toLocaleDateString()}`
            : 'Never expires';
        } else {
          knob.style.transform = 'translateX(0)';
          knob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#334155';
          options.style.display = 'none';
        }
      } catch (e) {
        console.error('Failed to load share status:', e);
      }

      // Get family share status if in family
      if (currentFamily && currentFamily.hasFamily) {
        try {
          const familyStatus = await fetch(`/api/lifelog/entries/${entryId}/family-share`).then(r => r.json());

          const familyToggle = document.getElementById('familyShareToggle');
          const familyKnob = document.getElementById('familyShareToggleKnob');

          familyToggle.checked = familyStatus.familyShared;
          if (familyStatus.familyShared) {
            familyKnob.style.transform = 'translateX(22px)';
            familyKnob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#7c3aed';
          } else {
            familyKnob.style.transform = 'translateX(0)';
            familyKnob.parentElement.previousElementSibling.nextElementSibling.style.backgroundColor = '#334155';
          }
        } catch (e) {
          console.error('Failed to load family share status:', e);
        }
      }
    }

    // Close family modals on overlay click
    ['createFamilyModal', 'joinFamilyModal', 'inviteModal', 'familySettingsModal', 'profileModal'].forEach(id => {
      document.getElementById(id)?.addEventListener('click', (e) => {
        if (e.target.id === id && id !== 'profileModal') {
          document.getElementById(id).style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
